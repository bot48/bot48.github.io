<div class="chart-container col-md-6">
    <div id="chart-team"></div>
</div>
<div class="chart-container col-md-6">
    <div id="chart-team-gen"></div>
</div>
<div class="chart-container col-md-6">
    <div id="chart-age"></div>
</div>
<div class="chart-container col-md-6">
    <div id="chart-grad-year"></div>
</div>
<div class="chart-container col-md-6">
    <div id="chart-grad-month"></div>
</div>
<div class="chart-container col-md-12">
    <div id="chart-twitter"></div>
    <span id="detail-twitter"><a>Lihat Akun Twitter Selengkapnya</a></span>
</div>
<div class="chart-container col-md-12">
    <div id="chart-instagram"></div>
    <span id="detail-instagram"><a>Lihat Akun Instagram Selengkapnya</a></span>
</div>
<div class="chart-container col-md-12">
    <div id="chart-tiktok"></div>
    <span id="detail-tiktok"><a>Lihat Akun TikTok Selengkapnya</a></span>
</div>

<script>
    var colorTeamMap = {
        "Team J": 'rgba(202, 23, 29, 1)',
        "Team KIII": 'rgba(255, 241, 1, 1)',
        "Team T": 'rgba(248, 176, 202, 1)',
        "Academy Class A": 'rgba(27, 200, 248, 1)',
        "Academy Class B": 'rgba(27, 200, 248, 1)'
    }

    $('#detail-twitter').click(function () {
        $('#content').load('twitter.html?' + getShortDate());
    });

    $('#detail-instagram').click(function () {
        $('#content').load('instagram.html?' + getShortDate());
    });

    $('#detail-tiktok').click(function () {
        $('#content').load('tiktok.html?' + getShortDate());
    });

    $(document).ready(function () {
        $.getJSON('data/members.json?' + getShortDate(), function (dataMembers) {
            var generation = [];
            var year = [];

            var teamName = [];
            var teamCount = [];
            var teamGen = [];

            var gradYear = [];
            var gradMonth = [];

            var ageActive = [];
            var ageNonActive = [];
            var minAge = 0;
            var maxAge = 0;

            gradYear['Semua Gen'] = [];
            var end = new Date();
            $.each(dataMembers, function (key, entry) {
                if (generation.indexOf('Gen ' + entry.gen) === -1) {
                    generation.push('Gen ' + entry.gen)
                }
                if ('teams' in entry) {
                    for (i = 0; i < entry.teams.length; i++) {
                        if (teamName.indexOf(entry.teams[i]) === -1) {
                            teamName.push(entry.teams[i])
                            teamCount[entry.teams[i]] = 1
                            teamGen[entry.teams[i]] = []
                            teamGen[entry.teams[i]][entry.gen] = 1
                        } else {
                            teamCount[entry.teams[i]] = teamCount[entry.teams[i]] + 1;
                            if (teamGen[entry.teams[i]][entry.gen] === undefined) {
                                teamGen[entry.teams[i]][entry.gen] = 1
                            } else {
                                teamGen[entry.teams[i]][entry.gen] = teamGen[entry.teams[i]][entry.gen] + 1
                            }
                        }
                    }
                }
                if ('last_date' in entry) {
                    var dt = new Date(entry.last_date);
                    var dtYear = dt.getFullYear()
                    var dtMonth = dt.getMonth();
                    if (year.indexOf(dtYear) === -1) {
                        year.push(dtYear)
                        gradYear['Semua Gen'][dtYear] = 1
                    } else {
                        gradYear['Semua Gen'][dtYear] = gradYear['Semua Gen'][dtYear] + 1
                    }

                    if (gradYear[entry.gen] === undefined) {
                        gradYear[entry.gen] = []
                        gradYear[entry.gen][dtYear] = 1
                    } else {
                        if (gradYear[entry.gen][dtYear] == undefined) {
                            gradYear[entry.gen][dtYear] = 1
                        } else {
                            gradYear[entry.gen][dtYear] = gradYear[entry.gen][dtYear] + 1
                        }
                    }

                    if (gradMonth[dtMonth] === undefined) {
                        gradMonth[dtMonth] = 1
                    } else {
                        gradMonth[dtMonth] = gradMonth[dtMonth] + 1
                    }
                    endDate = new Date(entry.last_date);
                    age = getYears(entry.birth_date, endDate);
                    if (ageNonActive[age] == undefined) {
                        ageNonActive[age] = 1
                    } else {
                        ageNonActive[age] = ageNonActive[age] + 1
                    }
                    if (minAge == 0) {
                        minAge = age
                    } else if (minAge != 0 && age < minAge) {
                        minAge = age
                    }
                    if (maxAge == 0) {
                        maxAge = age
                    } else if (maxAge != 0 && age > maxAge) {
                        maxAge = age
                    }
                } else {
                    var endDate = end;
                    age = getYears(entry.birth_date, endDate);
                    if (ageActive[age] == undefined) {
                        ageActive[age] = 1
                    } else {
                        ageActive[age] = ageActive[age] + 1
                    }
                    if (minAge == 0) {
                        minAge = age
                    } else if (minAge != 0 && age < minAge) {
                        minAge = age
                    }
                    if (maxAge == 0) {
                        maxAge = age
                    } else if (maxAge != 0 && age > maxAge) {
                        maxAge = age
                    }
                }
            })

            // data team
            var dataTeam = []
            var colorTeam = []
            var labelTeam = []
            for (var key in teamCount) {
                dataTeam.push(teamCount[key])
                colorTeam.push(colorTeamMap[key])
                labelTeam.push(key)
            }
            renderChartTeam(dataTeam, labelTeam, colorTeam)

            // data team per gen
            var dataTeamGen = []
            for (var team in teamGen) {
                var dataSeries = []
                for (i = 0; i < generation.length; i++) {
                    if (teamGen[team][i + 1] === undefined) {
                        dataSeries.push(0)
                    } else {
                        dataSeries.push(teamGen[team][i + 1])
                    }
                }

                dataTeamGen.push({
                    name: team,
                    data: dataSeries,
                })
            }
            renderChartTeamGen(dataTeamGen, generation, colorTeam)

            // data sebaran umur member
            var ages = []
            var dataAgeActive = []
            var dataAgeNonActive = []
            for (i = minAge; i <= maxAge; i++) {
                ages.push(i)
                if (ageActive[i] === undefined) {
                    dataAgeActive.push(0)
                } else {
                    dataAgeActive.push(ageActive[i])
                }
                if (ageNonActive[i] === undefined) {
                    dataAgeNonActive.push(0)
                } else {
                    dataAgeNonActive.push(ageNonActive[i])
                }
            }
            renderChartAge(dataAgeActive, dataAgeNonActive, ages)

            // data grad per tahun
            year.sort();
            dataGradYear = []
            for (var gen in gradYear) {
                var dataSeries = []
                for (i = 0; i < year.length; i++) {
                    if (gradYear[gen][year[i]] === undefined) {
                        dataSeries.push(0)
                    } else {
                        dataSeries.push(gradYear[gen][year[i]])
                    }
                }
                if (gen != "Semua Gen") {
                    gen = "Gen " + gen
                }
                dataGradYear.push({
                    data: dataSeries,
                    name: gen,
                })
            }
            renderChartGradYear(dataGradYear, year)

            // data grad per bulan
            renderChartGradMonth(gradMonth, months)

            $.getJSON('data/twitter.json?' + getShortDate(), function (dataTwitter) {
                dataTwitter = dataTwitter.members
                usernameTwitter = []
                followerTwitter = []
                dataTwitter.sort((a, b) => (a.follower > b.follower) ? 1 : -1)

                $.each(dataTwitter, function (key, entry) {
                    usernameTwitter.push(entry.username)
                    followerTwitter.push(entry.follower)
                })

                followerTwitter = followerTwitter.slice(followerTwitter.length - 16, followerTwitter.length)
                usernameTwitter = usernameTwitter.slice(usernameTwitter.length - 16, usernameTwitter.length)

                renderChartTwitter(followerTwitter, usernameTwitter)
            });

            $.getJSON('data/instagram.json?' + getShortDate(), function (dataInstagram) {
                dataInstagram = dataInstagram.members
                usernameInstagram = []
                followerInstagram = []
                dataInstagram.sort((a, b) => (a.follower > b.follower) ? 1 : -1)

                $.each(dataInstagram, function (key, entry) {
                    usernameInstagram.push(entry.username)
                    followerInstagram.push(entry.follower)
                })

                followerInstagram = followerInstagram.slice(followerInstagram.length - 16, followerInstagram.length)
                usernameInstagram = usernameInstagram.slice(usernameInstagram.length - 16, usernameInstagram.length)

                renderChartInstagram(followerInstagram, usernameInstagram)
            });

            $.getJSON('data/tiktok.json?' + getShortDate(), function (dataTiktok) {
                dataTiktok = dataTiktok.members
                usernameTiktok = []
                followerTiktok = []
                dataTiktok.sort((a, b) => (a.follower > b.follower) ? 1 : -1)

                $.each(dataTiktok, function (key, entry) {
                    usernameTiktok.push(entry.username)
                    followerTiktok.push(entry.follower)
                })

                followerTiktok = followerTiktok.slice(followerTiktok.length - 16, followerTiktok.length)
                usernameTiktok = usernameTiktok.slice(usernameTiktok.length - 16, usernameTiktok.length)

                renderChartTiktok(followerTiktok, usernameTiktok)
            });

        });

    });

    function renderChartTeam(data, labels, colors) {
        var options = {
            series: data,
            colors: colors,
            labels: labels,
            chart: {
                height: '300',
                type: 'pie',
            },
            title: {
                text: 'Jumlah Member per Team',
                align: 'center'
            },
            legend: {
                position: 'top',
            },
            dataLabels: {
                formatter: function (val, opts) {
                    return opts.w.config.series[opts.seriesIndex]
                },
            },
            responsive: [{
                breakpoint: 480,
                options: {
                    title: {
                        style: {
                            fontSize: '12',
                        }
                    },
                    legend: {
                        fontSize: '10'
                    },
                    chart: {
                        height: '200',
                    }
                }
            }]
        };

        var chart = new ApexCharts(document.querySelector("#chart-team"), options);
        chart.render();
    }

    function renderChartTeamGen(data, gen, colors) {
        var options = {
            series: data,
            // colors: colors,
            xaxis: {
                categories: gen
            },
            chart: {
                height: '300',
                type: 'radar',
                toolbar: {
                    show: false
                }
            },
            title: {
                text: 'Jumlah Member Team per Generasi',
                align: 'center'
            },
            legend: {
                position: 'top',
            },
            responsive: [{
                breakpoint: 480,
                options: {
                    title: {
                        style: {
                            fontSize: '12',
                        }
                    },
                    legend: {
                        fontSize: '10'
                    },
                }
            }]
        };

        var chart = new ApexCharts(document.querySelector("#chart-team-gen"), options);
        chart.render();
    }

    function renderChartAge(dataActive, dataNonActive, ages) {
        var options = {
            series: [{
                name: 'Member Aktif',
                data: dataActive
            },
            {
                name: 'Saat Graduate',
                data: dataNonActive
            }],
            xaxis: {
                categories: ages,
            },
            title: {
                text: 'Sebaran Umur Member',
                align: 'center'
            },
            legend: {
                position: 'top',
            },
            chart: {
                type: 'bar',
                height: 300,
                toolbar: {
                    show: false
                }
            },
            responsive: [{
                breakpoint: 480,
                options: {
                    title: {
                        style: {
                            fontSize: '12',
                        }
                    },
                    legend: {
                        fontSize: '10'
                    },
                }
            }]
        };

        var chart = new ApexCharts(document.querySelector("#chart-age"), options);
        chart.render();

    }

    function renderChartGradYear(data, year) {
        var options = {
            series: data,
            xaxis: {
                categories: year,
            },
            chart: {
                height: '300',
                type: 'line',
                toolbar: {
                    show: false
                }
            },
            legend: {
                position: 'top',
            },
            stroke: {
                curve: 'straight',
                width: 1.5
            },
            title: {
                text: 'Jumlah Grad dari Tahun ke Tahun',
                align: 'center'
            },
            responsive: [{
                breakpoint: 480,
                options: {
                    title: {
                        style: {
                            fontSize: '12',
                        }
                    },
                    legend: {
                        fontSize: '10'
                    },
                }
            }]
        };

        var chart = new ApexCharts(document.querySelector("#chart-grad-year"), options);
        chart.render();
    }

    function renderChartGradMonth(data, months) {
        var options = {
            series: [{
                name: 'Grad',
                data: data
            }],
            xaxis: {
                categories: months,
            },
            title: {
                text: 'Jumlah Grad dari Bulan ke Bulan',
                align: 'center'
            },
            chart: {
                type: 'bar',
                height: 300,
                toolbar: {
                    show: false
                }
            },
            responsive: [{
                breakpoint: 480,
                options: {
                    title: {
                        style: {
                            fontSize: '12',
                        }
                    }
                }
            }]
        };

        var chart = new ApexCharts(document.querySelector("#chart-grad-month"), options);
        chart.render();

    }

    function renderChartTwitter(data, members) {
        var options = {
            series: [{
                name: 'Follower',
                data: data
            }],
            xaxis: {
                categories: members,
            },
            title: {
                text: '16 Akun Twiiter dengan Follower Terbanyak',
                align: 'center'
            },
            plotOptions: {
                bar: {
                    horizontal: true,
                    distributed: true,
                    dataLabels: {
                        position: 'top'
                    }
                }
            },
            legend: {
                show: false,
            },
            dataLabels: {
                enabled: true,
                style: {
                    colors: ['#000']
                },
                formatter: function (val) {
                    return convertK(val)
                },
                offsetX: 40,
            },
            chart: {
                type: 'bar',
                toolbar: {
                    show: false
                },
            },
            responsive: [{
                breakpoint: 480,
                options: {
                    title: {
                        style: {
                            fontSize: '12',
                        }
                    },
                    chart: {
                        height: '600px'
                    },
                    xaxis: {
                        labels: {
                            show: true,
                            formatter: function (val) {
                                return convertK(val)
                            },
                        },
                    }
                }
            }]
        };

        var chart = new ApexCharts(document.querySelector("#chart-twitter"), options);
        chart.render();
    }

    function renderChartInstagram(data, members) {
        var options = {
            series: [{
                name: 'Follower',
                data: data
            }],
            xaxis: {
                categories: members,
            },
            title: {
                text: '16 Akun Instagram dengan Follower Terbanyak',
                align: 'center'
            },
            plotOptions: {
                bar: {
                    horizontal: true,
                    distributed: true,
                    dataLabels: {
                        position: 'top'
                    }
                }
            },
            legend: {
                show: false,
            },
            dataLabels: {
                enabled: true,
                style: {
                    colors: ['#000']
                },
                formatter: function (val) {
                    return convertK(val)
                },
                offsetX: 40,
            },
            chart: {
                type: 'bar',
                toolbar: {
                    show: false
                },
            },
            responsive: [{
                breakpoint: 480,
                options: {
                    title: {
                        style: {
                            fontSize: '12',
                        }
                    },
                    chart: {
                        height: '600px'
                    },
                    xaxis: {
                        labels: {
                            show: true,
                            formatter: function (val) {
                                return convertK(val)
                            },
                        },
                    }
                }
            }]
        };

        var chart = new ApexCharts(document.querySelector("#chart-instagram"), options);
        chart.render();
    }

    function renderChartTiktok(data, members) {
        var options = {
            series: [{
                name: 'Follower',
                data: data
            }],
            xaxis: {
                categories: members,
            },
            title: {
                text: '16 Akun TikTok dengan Follower Terbanyak',
                align: 'center'
            },
            plotOptions: {
                bar: {
                    horizontal: true,
                    distributed: true,
                    dataLabels: {
                        position: 'top'
                    }
                }
            },
            legend: {
                show: false,
            },
            dataLabels: {
                enabled: true,
                style: {
                    colors: ['#000']
                },
                formatter: function (val) {
                    return convertK(val)
                },
                offsetX: 35,
            },
            chart: {
                type: 'bar',
                toolbar: {
                    show: false
                },
            },
            responsive: [{
                breakpoint: 480,
                options: {
                    title: {
                        style: {
                            fontSize: '12',
                        }
                    },
                    chart: {
                        height: '600px'
                    },
                    xaxis: {
                        labels: {
                            show: true,
                            formatter: function (val) {
                                return convertK(val)
                            },
                        },
                    }
                }
            }]
        };

        var chart = new ApexCharts(document.querySelector("#chart-tiktok"), options);
        chart.render();
    }

    function convertK(val) {
        val = parseInt(val / 1000)
        if (val == 0) {
            return val
        } else {
            return val + "K"
        }
    }
</script>